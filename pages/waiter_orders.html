<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Orders</title>
    <link rel="stylesheet" href="../styles/waiter_orders.css">
</head>
<body>
    <header>
        <h1 class="orders-heading">Pending Orders</h1>
    </header>

    <main>
        <div class="order-list" id="order-list">
            <!-- Orders will be inserted here by JavaScript -->
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Bukhari Restaurant</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const orderList = document.getElementById('order-list');
            const customerPhone = localStorage.getItem('workId');

            if (!customerPhone) {
                orderList.innerHTML = '<p>No customer phone found in local storage.</p>';
                return;
            }

            try {
                // Fetch only unpaid items for the customer
                const response = await fetch(`/api/items?customerPhone=${customerPhone}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch items');
                }

                const items = await response.json();

                if (items.length === 0) {
                    orderList.innerHTML = '<p>No pending orders.</p>';
                    return;
                }

                // Group items by table number
                const groupedItems = items.reduce((acc, item) => {
                    if (!acc[item.tableNumber]) {
                        acc[item.tableNumber] = [];
                    }
                    acc[item.tableNumber].push(item);
                    return acc;
                }, {});

                // Render grouped items
                for (const tableNumber in groupedItems) {
                    const tableDiv = document.createElement('div');
                    tableDiv.classList.add('table-group');
                    
                    let totalAmount = 0;
                    groupedItems[tableNumber].forEach(item => {
                        totalAmount += item.price * item.quantity;
                    });

                    tableDiv.innerHTML = `<h2>Table Number: ${tableNumber} - Total: Tsh ${totalAmount}</h2>`;

                    // Add click event listener to each table group
                    tableDiv.addEventListener('click', () => {
                        localStorage.setItem('selectedTableTotal', totalAmount);
                        localStorage.setItem('selectedTableNumber', tableNumber); // Ensure table number is stored
                        // Redirect to payment_details.html
                        window.location.href = 'payment_details.html';
                    });

                    groupedItems[tableNumber].forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('order-item');
                        itemDiv.innerHTML = `
                            <img src="${item.image}" alt="${item.name}">
                            <div class="order-item-details">
                                <h2>${item.name}</h2>
                                <p>${item.description}</p>
                                <p>Pieces: ${item.quantity}</p>
                                <p>Price: Tsh ${item.price}</p>
                                <p>State: ${item.state}</p>
                                <p>${item.paid}</p>
                            </div>
                        `;
                        tableDiv.appendChild(itemDiv);
                    });

                    orderList.appendChild(tableDiv);
                }
            } catch (error) {
                console.error('Error fetching items:', error);
                orderList.innerHTML = '<p>Failed to load orders. Please try again later.</p>';
            }
        });
    </script>
</body>
</html>
